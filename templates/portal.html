<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Platform - Portal</title>
    <link rel="stylesheet" href="/static/css/base.css">
    <link rel="stylesheet" href="/static/css/portal.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <style>
        /* Dark mode styling for course selector */
        body.dark #course-select,
        body.dark #course-select option {
            color: #ffffff !important;
        }
    </style>
</head>
<body>
    <div class="page">
        <!-- Toolbar -->
        <div class="toolbar">
            <div>
                <div style="display: flex; align-items: baseline; gap: 0.75rem;">
                    <h1 style="font-size: 1.5rem; font-weight: bold; margin: 0;">ğŸ“š Course:</h1>
                    <select id="course-select" style="font-weight: bold; font-size: 1.1rem;">
                        <option value="">-- Select Course --</option>
                    </select>
                </div>
                <p class="subtitle small">
                    Select a course and practice with tests
                    <span id="active-users-count" style="margin-left: 1rem; color: var(--primary);"></span>
                </p>
            </div>
            <div class="toolbar-buttons">
                <button type="button" id="btn-home" class="toolbar-btn">ğŸ  Home</button>
                <button type="button" id="btn-dashboard" class="toolbar-btn hidden">ğŸ“Š Dashboard</button>
                <button type="button" id="btn-logout" class="toolbar-btn">ğŸšª Logout</button>
                <button type="button" id="theme-toggle" class="theme-toggle">ğŸŒ™</button>
            </div>
        </div>

        <!-- Identification Card -->
        <div id="login-card" class="card">
            <h2>ğŸ” Identify Yourself</h2>
            <label for="student-dni">Enter your DNI:</label>
            <input type="text" id="student-dni" placeholder="e.g. 12345678" maxlength="20">
            <button type="button" id="load-dashboard">Load My Dashboard</button>
            <div id="error" class="hidden"></div>
        </div>

        <!-- Dashboard (hidden until login) -->
        <div id="dashboard" class="hidden">
            <!-- Welcome Section -->
            <div class="card">
                <h2 id="student-info">Welcome!</h2>
            </div>

            <!-- Teacher Panel (hidden for students) - Full Width -->
            <div id="teacher-panel" class="card hidden">
                <h2>ğŸ‘©â€ğŸ« Teacher Panel</h2>
                <p class="small" style="margin-bottom: 1rem; color: var(--text-muted);">
                    Manage tests and view detailed analytics.
                </p>

                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.5rem;">
                    <button type="button" id="btn-question-bank">ğŸ“š Manage Questions</button>
                    <button type="button" id="manage-users-btn">ğŸ‘¥ Manage Users</button>
                    <button type="button" id="load-analytics-btn">ğŸ“Š Show Analytics</button>
                </div>

                <div id="users-management" style="margin-top: 0.5rem; display: none;">
                    <h3>User Management</h3>
                    <div id="users-list" style="margin-top: 1rem;"></div>
                </div>

                <div id="analytics-output" style="margin-top: 0.5rem;"></div>
            </div>

            <!-- Power Student Panel (hidden for regular students) - Full Width -->
            <div id="power-student-panel" class="card hidden">
                <h2>âš¡ Power Student Features</h2>
                <p class="small" style="margin-bottom: 1rem; color: var(--text-muted);">
                    Browse the question bank and access enhanced study features.
                </p>

                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.5rem;">
                    <button type="button" id="btn-browse-questions">ğŸ“š Browse Questions</button>
                    <button type="button" id="btn-suggest-question">ğŸ’¡ Suggest a Question</button>
                </div>

                <!-- Question Suggestion Form -->
                <div id="suggest-question-form" class="hidden" style="margin-top: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: 4px;">
                    <h3>Suggest a New Question</h3>
                    <p class="small" style="color: var(--text-muted); margin-bottom: 0.5rem;">Your suggestion will be reviewed by teachers.</p>

                    <label for="suggest-question-text">Question Text:</label>
                    <textarea id="suggest-question-text" rows="3" placeholder="Enter your question..." style="width: 100%; margin-bottom: 0.5rem;"></textarea>

                    <label>Answer Options (mark the correct one):</label>
                    <div style="margin-bottom: 0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                            <input type="radio" name="suggest-correct" value="0" checked>
                            <span style="font-weight: bold;">A:</span>
                            <input type="text" id="suggest-option-0" placeholder="Option A" style="flex: 1;">
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                            <input type="radio" name="suggest-correct" value="1">
                            <span style="font-weight: bold;">B:</span>
                            <input type="text" id="suggest-option-1" placeholder="Option B" style="flex: 1;">
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                            <input type="radio" name="suggest-correct" value="2">
                            <span style="font-weight: bold;">C:</span>
                            <input type="text" id="suggest-option-2" placeholder="Option C" style="flex: 1;">
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <input type="radio" name="suggest-correct" value="3">
                            <span style="font-weight: bold;">D:</span>
                            <input type="text" id="suggest-option-3" placeholder="Option D" style="flex: 1;">
                        </label>
                    </div>

                    <div style="display: flex; gap: 0.5rem;">
                        <button type="button" id="btn-submit-suggestion">ğŸ“¤ Submit Suggestion</button>
                        <button type="button" id="btn-cancel-suggestion" class="btn-secondary">Cancel</button>
                    </div>
                    <div id="suggestion-result" style="margin-top: 0.5rem;"></div>
                </div>
            </div>

            <div class="two-columns" style="grid-template-columns: 1fr 2fr;">
                <!-- Left Column: Take a Test -->
                <div class="card">
                    <h2>ğŸ“ Take a Test</h2>

                    <label for="test-select">Select Test:</label>
                    <select id="test-select">
                        <option value="">Loading...</option>
                    </select>

                    <div style="margin-top: 0.5rem; display: flex; flex-direction: column; gap: 0.5rem;">
                        <button type="button" id="start-selected-test" style="width: 100%;">â–¶ï¸ Start Test</button>
                        <button type="button" id="share-test-btn" style="width: 100%;">ğŸ”— Copy Share Link</button>
                        <button type="button" id="view-podium-btn" style="width: 100%;">ğŸ† View Podium</button>
                        <button type="button" id="rename-test-btn" style="width: 100%;">âœï¸ Rename Test</button>
                        <button type="button" id="delete-test-btn" style="width: 100%;">ğŸ—‘ï¸ Delete Test</button>
                    </div>

                    <div id="podium-info" style="margin-top: 0.5rem;"></div>
                    <div id="rename-info" style="margin-top: 0.5rem;"></div>
                    <div id="delete-test-info" style="margin-top: 0.5rem;"></div>

                    <h3 style="margin-top: 1.2rem;">ğŸ² Create Random Test</h3>
                    
                    <label for="test-name">Test Name (optional):</label>
                    <input type="text" id="test-name" placeholder="My Custom Test" maxlength="100">
                    
                    <label for="num-questions">Number of Questions:</label>
                    <input type="number" id="num-questions" value="20" min="1" max="100">

                    <!-- Test configuration options (all students) -->
                    <div id="test-config-container">
                        <label for="test-type">Test Type:</label>
                        <select id="test-type">
                            <option value="quiz">Quiz</option>
                            <option value="practice">Practice</option>
                            <option value="exam">Exam</option>
                        </select>

                        <label for="max-attempts">Max Attempts (leave empty for unlimited):</label>
                        <input type="number" id="max-attempts" placeholder="âˆ" min="1" max="100">

                        <label for="time-limit">Time Limit (minutes, optional):</label>
                        <input type="number" id="time-limit" placeholder="No limit" min="1" max="300">

                        <div style="margin-top: 0.5rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="randomize-questions">
                                <span>Randomize question order</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin-top: 0.25rem;">
                                <input type="checkbox" id="randomize-options">
                                <span>Randomize answer options</span>
                            </label>
                        </div>
                    </div>
                    <button type="button" id="create-random-test"  style="width: 100%;">ğŸ¯ Create & Start</button>
                    <div id="random-info" style="margin-top: 0.5rem;"></div>
                </div>

                <!-- Right Column: My Attempts -->
                <div class="card">
                    <h2>ğŸ“ˆ My Attempts</h2>
                    
                    <div id="attempts-empty" class="hidden">
                        <p style="color: var(--text-muted); font-style: italic;">No attempts yet. Take a test to see your results here!</p>
                    </div>
                    
                    <div id="attempts-table-wrapper" class="hidden">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Test</th>
                                        <th>#</th>
                                        <th>Score</th>
                                        <th>%</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="attempts-table-body">
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div style="height: 180px; margin-top: 1rem;">
                        <canvas id="attempts-chart"></canvas>
                    </div>

                    <!-- Weak Questions Section -->
                    <div style="margin-top: 1.5rem;">
                        <button type="button" id="btn-show-weak-questions" style="width: 100%;">ğŸ“Š Show My Weak Topics</button>
                        <div id="weak-questions-section" class="hidden" style="margin-top: 1rem;">
                            <h3>Questions You Struggle With</h3>
                            <div id="weak-questions-list" style="margin-top: 0.5rem;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer with version -->
        <footer style="text-align: center; margin-top: 2rem; padding: 1rem; color: var(--text-muted); font-size: 0.85rem;">
            <p id="version-display">Loading version...</p>
            <p style="margin-top: 0.5rem;">
                This quiz platform is for educational purposes only. 
                Questions are based on publicly available Google Cloud documentation.
            </p>
        </footer>
    </div>

    <script src="/static/js/portal.js"></script>
    <script>
        // Fetch and display version
        fetch('/version')
            .then(r => r.json())
            .then(data => {
                document.getElementById('version-display').textContent =
                    'Version: ' + (data.version || 'unknown');
            })
            .catch(() => {
                document.getElementById('version-display').textContent = 'Version: unknown';
            });

        // Fetch and display active users count
        fetch('/users/stats')
            .then(r => r.json())
            .then(data => {
                document.getElementById('active-users-count').textContent =
                    'ğŸ‘¥ ' + data.active_users + ' active, ' + data.inactive_users + ' inactive';
            })
            .catch(() => {
                document.getElementById('active-users-count').textContent = '';
            });
    </script>
</body>
</html>
